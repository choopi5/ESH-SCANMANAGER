"""
Vulnerability sender module for sending vulnerability data to API endpoints.
"""
from .base_sender import *

def send_vulnerabilities_to_api(project_id, file_path='enriched_vulnerabilities.json'):
    """Send vulnerabilities to the API"""
    print(f"\n{'='*80}")
    print("SENDING VULNERABILITIES REQUEST")
    print(f"{'='*80}")
    
    # Get absolute path if relative path is provided
    abs_file_path = os.path.abspath(file_path)
    server_url = API_BASE_URL
    
    # Read vulnerabilities from file
    try:
        with open(abs_file_path, 'r') as file:
            vulnerabilities = json.load(file)
    except Exception as e:
        print(f"Error reading file {abs_file_path}: {e}")
        return False
    # Prepare API request
    url = server_url + "vulnerabilities.php"
    
    # Prepare batch payload
    vuln_list = []
    for vuln in vulnerabilities:
        # Determine endpoint type and value
        endpoint_type = "subdomain"  # Default to subdomain
        endpoint_value = vuln.get('host', '')  # Get host from vulnerability data
        
        # If no host, try to get from other possible fields
        if not endpoint_value:
            endpoint_value = vuln.get('target', '')
        if not endpoint_value:
            endpoint_value = vuln.get('domain', '')
        if not endpoint_value:
            endpoint_value = vuln.get('ip', '')
            
        # If still no endpoint value, skip this vulnerability
        if not endpoint_value:
            print(f"Warning: Skipping vulnerability {vuln.get('name', 'Unknown')} - No endpoint value found")
            continue
        
        # If target is an IP address, change endpoint type
        if re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', endpoint_value):
            endpoint_type = "ip"
        
        vuln_list.append({
            "name": vuln.get('name', ''),
            "cve_id": vuln.get('cve_id', ''),
            "severity": normalize_severity(vuln.get('severity', 'Unknown')),
            "status": "Active",  # Default status
            "description": vuln.get('description', ''),
            "remediation": vuln.get('remediation', ''),
            "discovery_date": vuln.get('discovery_date', datetime.now().strftime('%Y-%m-%d')),
            "organization_id": project_id,
            "notes": f"Added via API - Project ID: {project_id}",
            "endpoint_type": endpoint_type,
            "endpoint_value": endpoint_value
        })
    
    if not vuln_list:
        print("No valid vulnerabilities to send (all were skipped due to missing endpoint values)")
        return
        
    payload = {
        "vulnerabilities": vuln_list
    }
    
    headers = get_api_headers()

    # Print complete request details
    print("\nREQUEST DETAILS:")
    print(f"URL: {url}")
    print("\nHEADERS:")
    for key, value in headers.items():
        print(f"{key}: {value}")
    print("\nPAYLOAD:")
    print(json.dumps(payload, indent=2))
    print(f"\nTotal vulnerabilities being sent: {len(vuln_list)}")
    print(f"{'='*80}\n")

    # Send request
    try:
        response = send_request_with_retry(url, payload, headers)
        
        # Print response details
        print("\nRESPONSE DETAILS:")
        print(f"Status Code: {response.status_code}")
        print("\nResponse Headers:")
        for key, value in response.headers.items():
            print(f"{key}: {value}")
        print("\nResponse Body:")
        print(response.text)
        print(f"{'='*80}\n")
        
        if response.status_code in [200, 201]:
            print(f"Successfully sent {len(vuln_list)} vulnerabilities to API")
            return True
        else:
            print(f"Failed to send vulnerabilities. Status code: {response.status_code}")
            return False
    
    except requests.exceptions.RequestException as e:
        print("\n❌ Connection Error!")
        print(f"Error: {str(e)}")
        if hasattr(e, 'response') and e.response is not None:
            print(f"Response Status: {e.response.status_code}")
            print(f"Response Headers: {json.dumps(dict(e.response.headers), indent=2)}")
            print(f"Response Content: {e.response.text}")
        return False
    except Exception as e:
        print("\n❌ Unexpected Error!")
        print(f"Error: {str(e)}")
        print(f"Error type: {type(e)}")
        return False 